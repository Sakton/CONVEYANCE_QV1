-- BASE TABLE
CREATE SCHEMA IF NOT EXISTS auto; -- Пространство имен для таблиц авто

CREATE TABLE auto.autobrands (
	autobrand_id SERIAL UNIQUE,
	autobrand_name VARCHAR(256) UNIQUE NOT NULL,
	autobrand_icon VARCHAR(256) DEFAULT ('no_icon.png')
);

CREATE TABLE auto.autocategories ( -- Категории прав и автомобилей
	autocategory_id SERIAL UNIQUE,
	autocategory_name VARCHAR(256) NOT NULL,
	autocategory_symbol VARCHAR (5) NOT NULL,
	autocategory_icon VARCHAR(64),
	autocategory_description TEXT
);


https://profi-prim.ru/article/kategorii-prav#:~:text=%D0%B2%20%D1%81%D0%B5%D0%B3%D0%BE%D0%B4%D0%BD%D1%8F%D1%88%D0%BD%D0%B5%D0%BC%20%D1%82%D0%B5%D0%BA%D1%81%D1%82%D0%B5.-,%D0%92%20%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B8%20%D1%81%D1%83%D1%89%D0%B5%D1%81%D1%82%D0%B2%D1%83%D0%B5%D1%82%2010%20%D0%BA%D0%B0%D1%82%D0%B5%D0%B3%D0%BE%D1%80%D0%B8%D0%B9%20%D0%BF%D1%80%D0%B0%D0%B2%3A%20%D0%9C%20%E2%80%94%20%D0%BC%D0%BE%D0%BF%D0%B5%D0%B4%D1%8B%20%D0%B8%20%D0%BB%D0%B5%D0%B3%D0%BA%D0%B8%D0%B5,%D1%82%D0%BE%D0%BD%D0%BD%3B%20%D0%A1%D0%95%20%E2%80%94%20%D0%B3%D1%80%D1%83%D0%B7%D0%BE%D0%B2%D1%8B%D0%B5%20%D0%B0%D0%B2%D1%82%D0%BE%D0%BC%D0%BE%D0%B1%D0%B8%D0%BB%D0%B8%20%D1%81


INSERT INTO auto.autocategories ( autocategory_name, autocategory_symbol, autocategory_icon, autocategory_description )
VALUES ( 'Мопеды и Легкие квадрициклы','M','M.png','Категория М дает право водить мопеды и легкие квадрициклы.
												    Особенность управления этими ТС в том, что ими можно управлять 
												    имея любую другую категорию водительских прав. За исключением 
												    удостоверения тракториста-машиниста и наличия иностранных водительских прав.
												    Важно! Чтобы водить квадроцикл или снегоход, 
												    эта категория прав не подходит. 
												    Для управления этими ТС нужно иметь удостоверение тракториста-машиниста
												    категории А1 — внедорожные транспортные средства. 
												    При этом А1 относится не к автомобильным категориям прав, 
												    а к категориям управления специальной техникой.' ),
	   ( 'Мотоциклы', 'A', 'A.png', 'Категория A дает право управлять любыми мотоциклами' ),
	   ( 'Легкие мотоциклы', 'A1', 'A1.png', 'Позволяет управлять мотоциклами с объемом двигателя, не превышающим 125 куб. см и максимальной мощностью не более 11 киловатт.' ),
	   ( 'Легковые автомобили и небольшие грузовики', 'B', 'B.png', 'Автомобили, масса которых не превышает 3,5 тонны, а число сидячих мест 
													(помимо сиденья водителя) не превышает восьми;
													автомобили, сцепленные с прицепом, разрешенная масса которого не более 750 кг;
													автомобили, сцепленные с прицепом, разрешенная максимальная масса которого превышает 750 кг,
													но не превышает массы автомобиля без нагрузки, при условии, что общая максимальная масса такого
													состава транспортных средств не превышает 3,5 тонны.
													К перечисленным выше условиям могут относиться не только легковые автомобили,
													но и небольшие грузовики, микроавтобусы и джипы.' ),
		( 'Трициклы и квадрициклы', 'B1', 'B1.png', 'Дает право на управление трициклами и квадрициклами. Это транспортные средства с тремя и четырьмя колесами соответственно.' ),
		( 'Легковые автомобили с прицепом', 'BE', 'BE.png', 'Позволяет управлять автомобилем категории В с тяжелым прицепом:
													разрешенная максимальная масса которого превышает 750 кг и превышает массу автомобиля без нагрузки;
													разрешенная максимальная масса которого превышает 750 кг,
													при условии, что общая разрешенная максимальная масса такого
													состава транспортных средств превышает 3,5 тонны.' ),
		( 'Грузовые автомобили от 3,5 тонн', 'C', 'C.png', 'Позволяют управлять автомобилями, максимальная масса которых превышает 3,5 тонны, за исключением машин категории D;
													автомобилями, сцепленными с прицепами, разрешенная максимальная масса которых не превышает 750 кг.' ),
		( 'Средние грузовики (от 3,5 до 7,5 тонн)', 'C1', 'C1.png', 'Дает право управлять автомобилем, разрешенная максимальная масса которого превышает 3,5 тонны, 
													но не превышает 7,5 тонн, за исключение автомобилей категории D.
													автомобилем с прицепом, разрешенная максимальная масса которого не более 750 кг.' ),
		( 'Средние грузовые автомобили с прицепом', 'C1E', 'C1E.png', 'Позволяет управлять:
													автомобилями подкатегории С1, сцепленными с тяжелым прицепом (более 750 кг).
													При условии, что общая масса этого состава ТС не более 12 тонн.' ),
		( 'Грузовые автомобили с прицепом', 'CE', 'CE.png', 'Дает возможность управлять автомобилями категории С, сцепленными прицепами, 
															разрешенная максимальная масса которых превышает 750 кг.' ),
		( 'Автобусы, имеющие более 8 сидячих мест', 'D', 'D.png', 'Дает право управлять:
													автомобилями для перевозки пассажиров и имеющими более 8 сидячих мест, помимо сиденья водителя;
													автобусами с прицепом, вес которого не превышает 750 кг. 
													То есть к этой категории относятся как маленькие, так и большие туристические автобусы.
													Единственное исключение — автобусы с «гармошкой».' ),
		( 'Небольшие автобусы', 'D1', 'D1.png', 'Позволяет управлять небольшими автобусами, которые имеют от 9 до 16 сидячих мест, помимо сиденья водителя. 
													Также дает право использовать легкий прицеп до 750 кг.' ),
		( 'Небольшие автобусы с прицепом', 'D1E', 'D1E.png', 'Дает право управлять автомобилем подкатегории D1, сцепленными с прицепом, разрешенная масса 
													которого превышает 750 кг, но не превышает массу автомобиля без нагрузки.  
													Суммарный вес такого ТС не должен превышать 12 тонн, а прицеп не должен быть предназначен для перевозки пассажиров.
													Важно! Водители, имеющие права категории D, могут управлять автобусами подкатегории D1, а категория DE дает возможность
													управлять автобусами с прицепом подкатегории D1Е.' ),
		( 'Автобусы с прицепом', 'DE', 'DE.png', 'Дает возможность управлять сочленными автобусами и буксировать прицепы весом более 750 кг.' ),
		( 'Троллейбусы', 'Tb', 'Tb.png', 'Дают право управлять троллейбусами' ),
		( 'Трамваи', 'Tm', 'Tm.png', 'Дают право управлять трамваями' );


CREATE TABLE auto.carsmodels (
	carsmodel_id SERIAL UNIQUE,
	autobrand_id INTEGER NOT NULL,
	autocategory_id INTEGER NOT NULL,
	carsmodel_name VARCHAR ( 200 ),
	FOREIGN KEY ( autobrand_id ) REFERENCES auto.autobrands ( autobrand_id ), -- NO ACTION по умолчанию
	FOREIGN KEY ( autocategory_id ) REFERENCES auto.autocategories ( autocategory_id ) -- NO ACTION по умолчанию
);
-- NO ACTION - не даст удалить связанную строку из базовой тавблицы

-- Так как данные берутся из comboBox, а они из БД, то такие записи существуют
CREATE OR REPLACE FUNCTION auto.getAutobrand_id ( nameBrand VARCHAR ) RETURNS INTEGER AS
$$
	SELECT autobrand_id FROM auto.autobrands WHERE autobrand_name = nameBrand;
$$ 
LANGUAGE SQL;
--*************
CREATE OR REPLACE FUNCTION auto.getAutocategory_id ( nameCategory VARCHAR ) RETURNS INTEGER AS
$$
	SELECT autocategory_id FROM auto.autocategories WHERE autocategory_name = nameCategory;
$$
LANGUAGE SQL;
-- ************
CREATE OR REPLACE PROCEDURE auto.add_carmodel ( nameBrand VARCHAR, nameCategory VARCHAR, carModel VARCHAR ) 
LANGUAGE SQL
AS $$
	INSERT INTO auto.carsmodels ( autobrand_id, autocategory_id, carsmodel_name )
	VALUES ( ( SELECT auto.getAutobrand_id(nameBrand) ), ( SELECT auto.getAutocategory_id(nameCategory) ), carModel );
$$;
































